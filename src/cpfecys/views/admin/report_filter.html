{{extend 'template.html'}}
<div class="row-fluid">
    <div class="well span12" style="overflow:auto;">
  		<a onclick="window.history.back()" class="btn" ><i class="icon-arrow-left"></i> Back</a>
		<table class="table table-bordered">
			<thead>
                <tr>
                    <th colspan="10"></th>
                    <th colspan="2">{{=T('Actions')}}</th>
                </tr>
				<tr>
					<th>
						{{=T('Project')}}
					</th>
					<th>
						{{=T('Created')}}
					</th>
					<th>
						{{=T('School id')}}
					</th>
					<th>
						{{=T('User')}}
					</th>
					<th>
						{{=T('Restriction')}}
					</th>
					<th>
						{{=T('Score')}}
					</th>
					<th>
						{{=T('Status')}}
					</th>
					<th>
                        {{=T('Report Summary')}}
					</th>
					<th>
						{{=T('Started')}}
					</th>
					<th>
						{{=T('Ends')}}
					</th>
                    <th>
                        <div class="right pull-right">
                            {{=T('DTT Approval')}}:
                            <a class="btn btn-success"
                               href="{{=URL('admin','dtt_general_approval', vars=dict(approve = True, status = status, period = period))}}">
                            <span class="icon-check"></span>
                            </a>
                            <a class="btn btn-danger"
                               href="{{=URL('admin','dtt_general_approval', vars=dict(approve = False, status = status, period = period))}}">
                            <span class="icon-remove"></span>
                            </a>
                            <a class="btn"
                               href="{{=URL('admin','dtt_general_approval', vars=dict(status = status, period = period))}}">
                            <span class="icon-time"></span>
                            </a>
                        </div>
                    </th>
					<th>
						{{=T('Report')}}
                    </th>
				</tr>
			</thead>
			<tbody>
				{{for report in reports:}}
				{{hours_left = 400}}
				{{hours_left = hours_left - (report.hours or 0)}}
                {{hours = report.hours}}
                {{show = False}}
                {{entries = \
                    count_log_entries(report)[0]['COUNT(log_entry.id)']}}
                {{metrics = \
                    count_metrics_report(report)[0]['COUNT(log_metrics.id)']}}
                {{anomalies = \
                    count_anomalies(report)[0]['COUNT(log_entry.id)']}}
                {{if report.assignation.project.area_level.name==\
                    'DTT Tutor Acad√©mico':}}
                    {{if metrics != 0 or entries != 0 or anomalies != 0:}}
                        {{show = True}}
                    {{pass}}
                {{else:}}
                    {{if hours != 0 and hours != None:}}
                        {{show = True}}
                    {{pass}}
                {{pass}}
                    {{if show:}}
    				<tr>
    					<td>
    						{{=report.assignation.project.name}}	
    					</td>
    					<td>
    						{{=report.created}}	
    					</td>
    					<td>
    						{{=report.assignation.assigned_user.username}}	
    					</td>
    					<td>
    						{{=report.assignation.assigned_user.first_name}}
    						{{=report.assignation.assigned_user.last_name}}
    					</td>
    					<td>
    						{{=report.report_restriction.name}}	
    					</td>
    					<td>
    						{{=report.score or 0}}	
    					</td>
    					<td>
    						{{=T(report.status.name)}}
    					</td>
    					<td>
                            <b>{{=T('Activity logs')}}:</b>
    						{{=entries}}
                            <br />
                            <b>{{=T('Metric logs')}}:</b>
                            {{=metrics}}
                            <br />
                            <b>{{=T('Hours')}}:</b>
                            {{=hours or 0}}
                            <br />
                            <b>{{=T('Pending Hours')}}:</b>
                            {{=hours_left}}
                            <br />
                            <b>{{=T('Anomalies')}}:</b>
                            {{=anomalies}}
    					</td>
    					<td>
    						{{=report.assignation.period.yearp}} - {{=T(report.assignation.period.period.name)}}
    					</td>
    					<td>
    						{{=calculate_ending_date(report)}}
    					</td>
                        <td>
                            {{if report.dtt_approval is None:}}
                            <span class="label">
                                {{=T('Pending Approval')}}
                            </span>
                            {{elif report.dtt_approval is True:}}
                            <span class="label label-success">
                                {{=T('Approved')}}
                            </span>
                            {{else:}}
                            <span class="label label-warning">
                                {{=T('Failed')}}
                            </span>
                            {{pass}}
                            <div class="pull-right right">
                                <a class="btn btn-success"
                               href="{{=URL('admin','dtt_approval', vars=dict(report=report.id, approve=True))}}">
                                <span class="icon-check"></span>
                                </a>
                                <a class="btn btn-danger"
                                   href="{{=URL('admin','dtt_approval', vars=dict(report=report.id, approve=False))}}">
                                <span class="icon-remove"></span>
                                </a>
                                <a class="btn"
                                   href="{{=URL('admin','dtt_approval', vars=dict(report=report.id))}}">
                                <span class="icon-time"></span>
                                </a>
                            </div>
                        </td>
    					<td>
    						<a class="btn " href="{{=URL('admin','report/view', vars=dict(report=report.id))}}">
    		                <span class="icon-eye-open"></span>
    		                    {{=T('Report detail')}}
    		                </a>
    					</td>
    				</tr>
                    {{pass}}
                {{pass}}
                <tr>
                    <td colspan="10"></td>
                    <td>
                        <div class="pull-right right">
                            <b>{{=T('DTT Approval')}}:</b>
                            <a class="btn btn-success"
                               href="{{=URL('admin','dtt_general_approval', vars=dict(approve = True, status = status, period = period))}}">
                            <span class="icon-check"></span>
                            </a>
                            <a class="btn btn-danger"
                               href="{{=URL('admin','dtt_general_approval', vars=dict(approve = False, status = status, period = period))}}">
                            <span class="icon-remove"></span>
                            </a>
                            <a class="btn"
                               href="{{=URL('admin','dtt_general_approval', vars=dict(status = status, period = period))}}">
                            <span class="icon-time"></span>
                            </a>
                        </div>
                        </td>
                    <td></td>
                </tr>
			</tbody>
		</table>
	</div>
</div>
