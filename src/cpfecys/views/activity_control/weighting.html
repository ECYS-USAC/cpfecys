
{{project_var = db(db.user_project.id == request.vars['assignation']).select().first() }}
{{if request.vars['op'] == "addCategory": }}

	{{total_var2=float(request.vars['grade_var'])}}

	{{for project in db((db.course_activity_category.semester==semestre2.id) & (db.course_activity_category.assignation==project_var.project.id)).select():}}		
		{{total_var2 = float(total_var2) + float(project.grade)}}				
	{{pass}}
	{{if float(total_var2) > 100:}}		
		<center>
			<span id="information_text" class="badge badge-important">{{=T('The total weighting exceeds 100 points.') }}</span>
		</center>
	{{else:}}
		{{project_var = db(db.user_project.id == request.vars['assignation']).select().first() }}

		{{db.course_activity_category.insert(category = int(request.vars['category_id_var']),
			                                grade =  request.vars['grade_var'], 
			                                specific_grade = request.vars['SG_var'], 
			                                semester = int(semestre2.id), 
			                                assignation = project_var.project.id, 
			                                laboratory = request.vars['laboratory'],
			                                teacher_permition = request.vars['TP'])}}
	{{pass}}

		
{{pass}}

<!--DELETE CATEGORY-->
{{if request.vars['op'] == "removeCategory": }}
	{{db(db.course_activity_category.id==request.vars['var_id']).delete()}}
{{pass}}

<!--UPDATE CATEGORY-->
{{if request.vars['op'] == "updateCategory": }}
	{{total_var2=float(request.vars['grade_var'])}}

	{{for project in db((db.course_activity_category.semester==semestre2.id) & (db.course_activity_category.assignation==project_var.project.id)).select():}}
		{{if str(project.id) != str(request.vars['var_id']):}}	
			{{total_var2 = float(total_var2) + float(project.grade)}}
		{{pass}}
	{{pass}}
	{{if float(total_var2) > 100:}}		
		<center>
			<span id="information_text" class="badge badge-important">{{=T('The total weighting exceeds 100 points.') }}</span>
		</center>
	{{else:}}
		{{db(db.course_activity_category.id==request.vars['var_id']).update(category = int(request.vars['category_id_var']),
			                                grade =  request.vars['grade_var'], 
			                                specific_grade = request.vars['SG_var'])}}			                                
	{{pass}}

{{pass}}



<!--ADD CATEGORY DIV-->
{{if request.vars['op'] == "showInsert": }}
	<label>{{=T('Category')}}:</label>
    <select class="generic-widget" id="category_id" name="category" style="width:250px;">
      {{project_var = db(db.user_project.id == request.vars['assignation']).select().first() }}
      {{cR = db((db.course_activity_category.semester==semestre2.id) & (db.course_activity_category.assignation==project_var.project.id)).select()}}
      {{categoriasP = []}}
      {{for c in cR:}}
          {{categoriasP.append(c.category)}}
      {{pass}}
      {{for project in db(~db.activity_category.id.belongs(categoriasP)).select():}}
          <option value="{{=project.id}}">{{=project.category}}</option>
      {{pass}}
    </select>
    <label>{{=T('Grade')}}:</label>
    <input class="string" name="academic_carnet" type="text" value="" id="category_grade" style="width:240px;">
    <label>
    	{{=T('Specific Grade')}}&nbsp &nbsp
    	<input type="checkbox" name="SG_check"  id="SG_check">  
    	<span title="{{=T('If you do not select the checkbox the activities of this category will be averaged.')}}" 
    	class=" icon-question-sign"></span>  	
    </label>
    	

{{pass}}

{{if request.vars['op2'] != None and request.vars['op2'] != "showInsert": }}
	
	{{request.vars['op'] = request.vars['op2']}}
{{pass}}

{{if  request.vars['op'] == "showTableNoEditable" or request.vars['op'] == "addCategory" or request.vars['op'] == "showTable" or request.vars['op'] == "removeCategory" or request.vars['op'] == "showEditTable" or request.vars['op'] == "showEditCategory" : }}
	<div>
	  <center>
		<table class="table table-striped table-bordered">
			<tr>
				<th>
					{{=T('Category')}}
				</th>
				<th>
					{{=T('Grade')}}
				</th>
				<th title="{{=T('Specific Grade')}}">
					{{=T('SG')}}
				</th>
				{{if request.vars['op'] != "showTableNoEditable":}}
					<th>
						{{=T('Actions')}}
					</th>
				{{pass}}
			</tr>
			{{total_var = 0}}
			{{for project in db((db.course_activity_category.semester==semestre2.id) & (db.course_activity_category.assignation==project_var.project.id)).select():}}
				{{editable_var='false'}}
				{{if request.vars['op'] == "showEditCategory":}}
	            	{{if str(request.vars['var_id']) == str(project.id):}}
	            		{{editable_var='true'}}
	            	{{else:}}
	            		{{editable_var='false'}}
	            	{{pass}}
	        	{{pass}}

			<tr>
				<td>
					{{if editable_var=='true':}}						
						<select class="generic-widget" id="edit_category_id" name="category" style="width:75px;">
							<option value="{{=project.category}}">{{=project.category.category}}</option>
					      {{project_var = db(db.user_project.id == request.vars['assignation']).select().first() }}
					      {{cR = db((db.course_activity_category.semester==semestre2.id) & (db.course_activity_category.assignation==project_var.project.id)).select()}}
					      {{categoriasP = []}}
					      {{for c in cR:}}
					          {{categoriasP.append(c.category)}}
					      {{pass}}
					      {{for cat in db(~db.activity_category.id.belongs(categoriasP)).select():}}
					          <option value="{{=cat.id}}">{{=cat.category}}</option>
					      {{pass}}
					    </select>
					{{else:}}
						{{=project.category.category}}
					{{pass}}
				</td>
				<td>
					{{if editable_var=='true':}}
						<input class="string" name="edit_grade" type="text" value="{{=project.grade}}" id="edit_grade" style="width:40px;">
					{{else:}}
						{{=project.grade}}
						
					{{pass}}
					{{total_var = total_var + project.grade}}					
				</td>
				<td>
					{{if editable_var=='true':}}
						{{if str(project.specific_grade) =='True':}}
							<input type="checkbox" name="edit_SG_check"  id="edit_SG_check" checked>
						{{else:}}
							<input type="checkbox" name="edit_SG_check"  id="edit_SG_check">
						{{pass}}						
					{{else:}}
						{{=project.specific_grade}}
					{{pass}}
				</td>
				{{if request.vars['op'] != "showTableNoEditable":}}
				<td>
					<center>
						

                    	{{if editable_var=='true':}}
							<a id="categoryButton" role="button" class="badge btn-success"  
							onclick="updateCategory({{=project.id}});"> 
	                    		<span class="icon-white icon-check"></span>
	                    	</a>
                    	{{else:}}
                    		
	                    		<a id="categoryButton" role="button" class="badge btn-info"  
								onclick="editCategory({{=project.id}});"> 
		                    		<span class="icon-white icon-edit"></span>
		                    	</a>

                    	{{pass}}

                    	<a id="categoryButton" role="button" class="badge btn-danger" 
                    	onclick="removeCategory({{=project.id}});" title="{{=T('Remove weighting category')}}" > 
                    		<span class="icon-white icon-remove-sign"></span>
                    	</a>
					</center>
				</td>
				{{pass}}
			</tr>
			{{pass}}
			<tr >
				<td style="background-color:#eee;">
					{{=T('Total')}}
				</td>
				<td style="background-color:#eee;">
					{{if total_var != 100:}}
						<b><font color="red">{{=total_var}}</font></b>
					{{else:}}
						<b><font color="green">{{=total_var}}</font></b>
					{{pass}}
				</td>
				<td style="background-color:#eee;">
				</td>
				{{if request.vars['op'] != "showTableNoEditable":}}
				<td style="background-color:#eee;">
				</td>
				{{pass}}
			</tr>
			
		<table>		
	  </center>	
	</div>
{{pass}}



<script type="text/javascript">
  	
  	$(document).ready(function(){
		
			
	});

	function editCategory(var_id){
			$("#div_weighting_show").load("{{=URL('activity_control','weighting.html')}}?op=showEditCategory&amp;var_id="+var_id+"&amp;assignation={{=request.vars['assignation']}}");
	}

	function updateCategory(var_id){
	  var category_id_var = document.getElementById('edit_category_id').value;
      var grade_var = document.getElementById('edit_grade').value;
      var SG_var = document.getElementById('edit_SG_check').checked;

	      if (category_id_var==""){
	        alert("{{=T('No categories available')}}");  
	      }else{
	      
	      var regex = /^\d+(?:\.\d{0,2})$/; 
	      var regex2 = /^([0-9])*$/; 

	        if (grade_var=="" || parseInt(grade_var) == 0 ){
	          alert("{{=T('The entered value is not correct')}}");  
	        }else{
	          if (!regex.test(grade_var) && !regex2.test(grade_var) ){
	            alert("{{=T('The entered value is not a decimal')}}");  
	          }else{
	            
	            $("#div_weighting_show").load("{{=URL('activity_control','weighting.html')}}?op=updateCategory&amp;var_id="+var_id+"&amp;op2=showEditTable&amp;SG_var=" + SG_var + "&amp;category_id_var=" + category_id_var +"&amp;grade_var=" + grade_var + "&amp;assignation={{=request.vars['assignation']}}"); 
	            $("#categoryDiv").load("{{=URL('activity_control','weighting.html')}}?op=showInsert&amp;assignation={{=request.vars['assignation']}}");
	            }       

	        }
	      }		
			
		}

	function removeCategory(var_id){
			$("#div_weighting_show").load("{{=URL('activity_control','weighting.html')}}?op=removeCategory&amp;op2={{=request.vars['op']}}&amp;var_id="+var_id+"&amp;assignation={{=request.vars['assignation']}}");

			$("#categoryDiv").load("{{=URL('activity_control','weighting.html')}}?op=showInsert&amp;assignation={{=request.vars['assignation']}}");
	}

</script>
