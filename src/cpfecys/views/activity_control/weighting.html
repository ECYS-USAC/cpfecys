{{project_var = db(db.user_project.id == request.vars['assignation']).select().first() }}
{{if request.vars['op'] == "addCategory": }}

	{{total_var2=float(request.vars['grade_var'])}}

	{{for project in db((db.course_activity_category.semester==semestre2.id) & (db.course_activity_category.assignation==project_var.project.id)).select():}}		
		{{total_var2 = float(total_var2) + float(project.grade)}}				
	{{pass}}
	{{if float(total_var2) > 100:}}		
		<center>
			<span id="information_text" class="badge badge-important">{{=T('The total weighting exceeds 100 points.') }}</span>
		</center>
	{{else:}}
		{{project_var = db(db.user_project.id == request.vars['assignation']).select().first() }}

		{{db.course_activity_category.insert(category = int(request.vars['category_id_var']),
			                                grade =  request.vars['grade_var'], 
			                                specific_grade = request.vars['SG_var'], 
			                                semester = int(semestre2.id), 
			                                assignation = project_var.project.id, 
			                                laboratory = request.vars['laboratory'],
			                                teacher_permition = request.vars['TP'])}}
	{{pass}}
		
{{pass}}

{{if request.vars['op'] == "removeCategory": }}
	{{db(db.course_activity_category.id==request.vars['var_id']).delete()}}
{{pass}}

{{if request.vars['op'] == "showInsert": }}
	<label>{{=T('Category')}}:</label>
    <select class="generic-widget" id="category_id" name="category" style="width:250px;">
      {{project_var = db(db.user_project.id == request.vars['assignation']).select().first() }}
      {{cR = db((db.course_activity_category.semester==semestre2.id) & (db.course_activity_category.assignation==project_var.project.id)).select()}}
      {{categoriasP = []}}
      {{for c in cR:}}
          {{categoriasP.append(c.category)}}
      {{pass}}
      {{for project in db(~db.activity_category.id.belongs(categoriasP)).select():}}
          <option value="{{=project.id}}">{{=project.category}}</option>
      {{pass}}
    </select>
    <label>{{=T('Grade')}}:</label>
    <input class="string" name="academic_carnet" type="text" value="" id="category_grade" style="width:240px;">
    <label>
    	{{=T('Specific Grade')}}&nbsp &nbsp
    	<input type="checkbox" name="SG_check"  id="SG_check">  
    	<span title="{{=T('If you do not select the checkbox the activities of this category will be averaged.')}}" 
    	class=" icon-question-sign"></span>  	
    </label>
    	

{{pass}}

{{if  request.vars['op'] == "showTableNoEditable" or request.vars['op'] == "addCategory" or request.vars['op'] == "showTable" or request.vars['op'] == "removeCategory": }}
	<div>
	  <center>
		<table class="table table-striped table-bordered">
			<tr>
				<th>
					{{=T('Category')}}
				</th>
				<th>
					{{=T('Grade')}}
				</th>
				<th title="{{=T('Specific Grade')}}">
					{{=T('SG')}}
				</th>
				{{if request.vars['op'] != "showTableNoEditable":}}
					<th>
						{{=T('Remove')}}
					</th>
				{{pass}}
			</tr>
			{{total_var = 0}}
			{{for project in db((db.course_activity_category.semester==semestre2.id) & (db.course_activity_category.assignation==project_var.project.id)).select():}}
			<tr>
				<td>
					{{=project.category.category}}
				</td>
				<td>
					{{=project.grade}}
					{{total_var = total_var + project.grade}}
				</td>
				<td>
					{{=project.specific_grade}}
				</td>
				{{if request.vars['op'] != "showTableNoEditable":}}
				<td>
					<center>
						<!--<a id="categoryButton" role="button" class="badge btn-info"  > 
                    		<span class="icon-white icon-edit"></span>
                    	</a>-->
                    	<a id="categoryButton" role="button" class="badge btn-danger" 
                    	onclick="removeCategory({{=project.id}});" title="{{=T('Remove weighting category')}}" > 
                    		<span class="icon-white icon-remove-sign"></span>
                    	</a>
					</center>
				</td>
				{{pass}}
			</tr>
			{{pass}}
			<tr >
				<td style="background-color:#eee;">
					{{=T('Total')}}
				</td>
				<td style="background-color:#eee;">
					{{if total_var != 100:}}
						<b><font color="red">{{=total_var}}</font></b>
					{{else:}}
						<b><font color="green">{{=total_var}}</font></b>
					{{pass}}
				</td>
				<td style="background-color:#eee;">
				</td>
				{{if request.vars['op'] != "showTableNoEditable":}}
				<td style="background-color:#eee;">
				</td>
				{{pass}}
			</tr>
			
		<table>		
	  </center>	
	</div>
{{pass}}



<script type="text/javascript">
  	$(document).ready(function(){
  		
			
	});

	function removeCategory(var_id){
			$("#div_weighting_show").load("{{=URL('activity_control','weighting.html')}}?op=removeCategory&amp;var_id="+var_id+"&amp;assignation={{=request.vars['assignation']}}");
			$("#categoryDiv").load("{{=URL('activity_control','weighting.html')}}?op=showInsert&amp;assignation={{=request.vars['assignation']}}");
		}

</script>
