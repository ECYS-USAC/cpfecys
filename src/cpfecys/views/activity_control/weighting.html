
{{project_var = db(db.user_project.id == request.vars['assignation']).select().first() }}
{{if request.vars['op'] == "addCategory": }}

	{{total_var2=float(request.vars['grade_var'])}}

	{{if auth.has_membership('Teacher'):}}
		{{for project in db((db.course_activity_category.semester==semestre2.id) & (db.course_activity_category.assignation==project_var.project.id) & (db.course_activity_category.laboratory==False)).select():}}		
			{{total_var2 = float(total_var2) + float(project.grade)}}				
		{{pass}}
	{{else:}}
		{{for project in db((db.course_activity_category.semester==semestre2.id) & (db.course_activity_category.assignation==project_var.project.id) & (db.course_activity_category.laboratory==True)).select():}}		
			{{total_var2 = float(total_var2) + float(project.grade)}}				
		{{pass}}
	{{pass}}
	{{if float(total_var2) > 100:}}		
		<center>
			<span id="information_text" class="badge badge-important">{{=T('The total weighting exceeds 100 points.') }}</span>
		</center>
	{{else:}}
		{{project_var = db(db.user_project.id == request.vars['assignation']).select().first() }}
		{{var_labo = 'true'}}
		{{if auth.has_membership('Teacher'):}}
			{{var_labo = 'false'}}
		{{pass}}

		{{var_SG = True}}
		{{if str(request.vars['SG_var']) == "true":}}
			{{var_SG = False}}
		{{pass}}


		{{db.course_activity_category.insert(category = int(request.vars['category_id_var']),
			                                grade =  request.vars['grade_var'], 
			                                specific_grade = var_SG, 
			                                semester = int(semestre2.id), 
			                                assignation = project_var.project.id, 
			                                laboratory = var_labo,
			                                teacher_permition = request.vars['TP'])}}
	{{pass}}

		
{{pass}}


<!--GET  WEIGHTING-->
{{if request.vars['op'] == "getPreviousWeighting": }}
	{{var_period_sel=str(request.vars['period_par'])}}

	{{project_var = db(db.user_project.id == request.vars['assignation']).select().first() }}
	{{var_labo = 'true'}}
	{{if auth.has_membership('Teacher'):}}
		{{var_labo = 'false'}}
	{{pass}}
	
	{{for we_pass in db((db.course_activity_category.semester==int(semestre2.id)) & (db.course_activity_category.assignation==project_var.project.id) & (db.course_activity_category.laboratory==var_labo)).select():}}	
		{{db(db.course_activity_category.id==we_pass.id).delete()}}
	{{pass}}

	{{for we in db((db.course_activity_category.semester==var_period_sel) & (db.course_activity_category.assignation==project_var.project.id) & (db.course_activity_category.laboratory==var_labo)).select():}}		
		
		{{db.course_activity_category.insert(category = we.category,
	                                grade =  we.grade,
	                                specific_grade = we.specific_grade,
	                                semester = int(semestre2.id), 
	                                assignation = project_var.project.id, 
	                                laboratory = we.laboratory,
	                                teacher_permition = we.teacher_permition)}}
	{{pass}}
	{{request.vars['op'] ="showTable"}}
		
{{pass}}



<!--DELETE CATEGORY-->
{{if request.vars['op'] == "removeCategory": }}
	{{var_labo = True}}
	{{if auth.has_membership('Teacher'):}}
		{{var_labo = False}}
	{{pass}}

	{{project_var = db(db.user_project.id == request.vars['assignation']).select().first() }}

	{{var_cac = db((db.course_activity.course_activity_category == request.vars['var_id']) & (db.course_activity.assignation == project_var.project.id) & (  db.course_activity.laboratory == var_labo) & (db.course_activity.semester == (semestre2.id) ) ).select().first() }}

	{{if var_cac != None:}}
		<script type="text/javascript">
		alert("{{=T('Unable to delete category because it already has some activity associated')}}");
		</script>
	{{else:}}
		{{db(db.course_activity_category.id==request.vars['var_id']).delete()}}
	{{pass}}
	
{{pass}}
	


	

<!--UPDATE CATEGORY-->
{{if request.vars['op'] == "updateCategory": }}
	{{total_var2=float(request.vars['grade_var'])}}



	{{if auth.has_membership('Teacher'):}}
		{{for project in db((db.course_activity_category.semester==semestre2.id) & (db.course_activity_category.assignation==project_var.project.id) & (db.course_activity_category.laboratory==False)).select():}}		
			{{if str(project.id) != str(request.vars['var_id']):}}	
				{{total_var2 = float(total_var2) + float(project.grade)}}
			{{pass}}
		{{pass}}
	{{else:}}
		{{for project in db((db.course_activity_category.semester==semestre2.id) & (db.course_activity_category.assignation==project_var.project.id) & (db.course_activity_category.laboratory==True)).select():}}		
			{{if str(project.id) != str(request.vars['var_id']):}}	
				{{total_var2 = float(total_var2) + float(project.grade)}}
			{{pass}}
		{{pass}}
	{{pass}}


	
	{{if float(total_var2) > 100:}}		
		<center>
			<span id="information_text" class="badge badge-important">{{=T('The total weighting exceeds 100 points.') }}</span>
		</center>
	{{else:}}
		{{var_SG = True}}
		{{if str(request.vars['SG_var']) == "true":}}
			{{var_SG = False}}
		{{pass}}

		{{var_TP = False}}
		{{if str(request.vars['TP_var']) == "true":}}
			{{var_TP = True}}
		{{pass}}

		{{db(db.course_activity_category.id==request.vars['var_id']).update(category = int(request.vars['category_id_var']),
			                                grade =  request.vars['grade_var'], 
			                                specific_grade = var_SG,
			                            	teacher_permition = var_TP)}}
	{{pass}}

{{pass}}



<!--ADD CATEGORY DIV-->
{{if request.vars['op'] == "showInsert": }}
	<label>{{=T('Category')}}:</label>
    <select class="generic-widget" id="category_id" name="category" style="width:250px;">
      {{project_var = db(db.user_project.id == request.vars['assignation']).select().first() }}


	 	{{if auth.has_membership('Teacher'):}}
			{{cR = db((db.course_activity_category.semester==semestre2.id) & (db.course_activity_category.assignation==project_var.project.id) & (db.course_activity_category.laboratory==False)).select()}}
			{{categoriasP = []}}
		    {{for c in cR:}}
		        {{categoriasP.append(c.category)}}
		    {{pass}}
		    {{for project in db(~db.activity_category.id.belongs(categoriasP) ).select():}}
		        <option value="{{=project.id}}">{{=project.category}}</option>
		    {{pass}}
		{{else:}}
			{{cR = db((db.course_activity_category.semester==semestre2.id) & (db.course_activity_category.assignation==project_var.project.id) & (db.course_activity_category.laboratory==True)).select()}}
			{{categoriasP = []}}
		    {{for c in cR:}}
		        {{categoriasP.append(c.category)}}
		    {{pass}}
		    {{for project in db((~db.activity_category.id.belongs(categoriasP)) & (db.activity_category.hidden_academic_tutor != True) ).select():}}
		        <option value="{{=project.id}}">{{=project.category}}</option>
		    {{pass}}
		{{pass}}
      
      
    </select>
    <label>{{=T('Grade')}}:</label>
    <input class="string" name="academic_carnet" type="text" value="" id="category_grade" style="width:240px;">
    	<br>
    	<div align="justify"> 
	    	{{=T('Do you want that all the activities in this category will be averaged?')}}
	    </div>
	    
    	<label>
    		<div align="right"> 
		    	{{=T('Yes')}}
		    	<input type="checkbox" name="SG_check"  id="SG_check">  
		    	<span title="{{=T('If you do not select the checkbox, when you create activities you must enter the weight of each activity.')}}" 
		    	class=" icon-question-sign"></span>  	
	    	</div>
    	</label>
    	<br>

    	{{if auth.has_membership('Teacher'):}}
	    	<div align="justify"> 
		    	{{=T('Do you want to give permissions to academic tutors so they can create activities in this category?')}}
		    </div>
		    
	    	<label>
	    		<div align="right"> 
			    	{{=T('Yes')}}
			    	<input type="checkbox" name="TP_check"  id="TP_check" > 			    		
		    	</div>
	    	</label>
	    {{else:}}
	    	<input type="checkbox" name="TP_check"  id="TP_check" checked style="opacity:0;">
	    {{pass}}
	    
    	

{{pass}}

{{if request.vars['op2'] != None and request.vars['op2'] != "showInsert": }}
	
	{{request.vars['op'] = request.vars['op2']}}
{{pass}}

{{if  request.vars['op'] == "showTableNoEditable" or request.vars['op'] == "addCategory" or request.vars['op'] == "showTable" or request.vars['op'] == "removeCategory" or request.vars['op'] == "showEditTable" or request.vars['op'] == "showEditCategory" or request.vars['op'] == "showTableNoEditablePeriod": }}
	<div>
	  <center>
		<table class="table table-striped table-bordered">
			{{var_period_sel=str(semestre2.id)}}

			{{if request.vars['op'] == "showTableNoEditablePeriod":}}
				{{var_period_sel=str(request.vars['period_par'])}}
				{{request.vars['op'] = "showTableNoEditable"}}
			{{pass}}
			
			<tr>
				<th>
					{{=T('Category')}}
				</th>
				<th>
					{{=T('Grade')}}
				</th>
				<th title="{{=T('Average Grades')}}">
					{{=T('AG')}}
				</th title="{{=T('Teacher Permition')}}">
				{{if auth.has_membership('Teacher'):}}
					<th>
						{{=T('TP')}}
					</th>
				{{pass}}
				{{if request.vars['op'] != "showTableNoEditable":}}
					<th>
						{{=T('Actions')}}
					</th>
				{{pass}}
			</tr>
			{{total_var = 0}}




			{{if auth.has_membership('Teacher'):}}
				{{for project in db((db.course_activity_category.semester==int(var_period_sel)) & (db.course_activity_category.assignation==project_var.project.id) & (db.course_activity_category.laboratory==False)).select():}}		
					{{editable_var='false'}}
					{{if request.vars['op'] == "showEditCategory":}}
		            	{{if str(request.vars['var_id']) == str(project.id):}}
		            		{{editable_var='true'}}
		            	{{else:}}
		            		{{editable_var='false'}}
		            	{{pass}}
		        	{{pass}}
						<tr>
						<td>
							{{if editable_var=='true':}}						
								<select class="generic-widget" id="edit_category_id" name="category" style="width:75px;">
									<option value="{{=project.category}}">{{=project.category.category}}</option>
							      {{project_var = db(db.user_project.id == request.vars['assignation']).select().first() }}

					      		{{if auth.has_membership('Teacher'):}}
									{{cR = db((db.course_activity_category.semester==semestre2.id) & (db.course_activity_category.assignation==project_var.project.id) & (db.course_activity_category.laboratory==False)).select()}}
									{{categoriasP = []}}
								      {{for c in cR:}}
								          {{categoriasP.append(c.category)}}
								      {{pass}}
								      {{for cat in db(~db.activity_category.id.belongs(categoriasP)).select():}}
								          <option value="{{=cat.id}}">{{=cat.category}}</option>
								      {{pass}}
								{{else:}}
									{{cR = db((db.course_activity_category.semester==semestre2.id) & (db.course_activity_category.assignation==project_var.project.id) & (db.course_activity_category.laboratory==True)).select()}}
									{{categoriasP = []}}
								    {{for c in cR:}}
								          {{categoriasP.append(c.category)}}
								      {{pass}}
								      {{for cat in db((~db.activity_category.id.belongs(categoriasP)) & (db.activity_category.hidden_academic_tutor != True) ).select():}}
								          <option value="{{=cat.id}}">{{=cat.category}}</option>
								      {{pass}}
								{{pass}}

							      
							      
							    </select>
							{{else:}}
								{{=project.category.category}}
							{{pass}}
						</td>
						<td>
							{{if editable_var=='true':}}
								<input class="string" name="edit_grade" type="text" value="{{=project.grade}}" id="edit_grade" style="width:40px;">
							{{else:}}
								{{=project.grade}}
								
							{{pass}}
							{{total_var = total_var + project.grade}}					
						</td>
						<td>
							{{var_sg = str(project.specific_grade)}}
							{{if var_sg == 'True':}}
								{{var_sg="False"}}
							{{else:}}
								{{var_sg="True"}}
							{{pass}}
							{{if editable_var=='true':}}
								
								{{if var_sg =='True':}}
									<input type="checkbox" name="edit_SG_check"  id="edit_SG_check" checked>
								{{else:}}
									<input type="checkbox" name="edit_SG_check"  id="edit_SG_check">
								{{pass}}						
							{{else:}}
								{{=var_sg}}
							{{pass}}
						</td>
						<td>
							{{if editable_var=='true':}}								
								{{if str(project.teacher_permition) =='True':}}
									<input type="checkbox" name="edit_TP_check"  id="edit_TP_check" checked>
								{{else:}}
									<input type="checkbox" name="edit_TP_check"  id="edit_TP_check">
								{{pass}}						
							{{else:}}
								{{=str(project.teacher_permition)}}
							{{pass}}
						</td>
						{{if request.vars['op'] != "showTableNoEditable":}}
						<td>
							<center>
								

		                    	{{if editable_var=='true':}}
									<a id="categoryButton" role="button" class="badge btn-success"  
									onclick="updateCategory({{=project.id}});"> 
			                    		<span class="icon-white icon-check"></span>
			                    	</a>
		                    	{{else:}}
		                    		
			                    		<a id="categoryButton" role="button" class="badge btn-info"  
										onclick="editCategory({{=project.id}});"> 
				                    		<span class="icon-white icon-edit"></span>
				                    	</a>

		                    	{{pass}}

		                    	<a id="categoryButton" role="button" class="badge btn-danger" 
		                    	onclick="removeCategory({{=project.id}});" title="{{=T('Remove weighting category')}}" > 
		                    		<span class="icon-white icon-remove-sign"></span>
		                    	</a>
							</center>
						</td>
						{{pass}}
					</tr>
			{{pass}}
			{{else:}}
				{{for project in db((db.course_activity_category.semester==int(var_period_sel)) & (db.course_activity_category.assignation==project_var.project.id) & (db.course_activity_category.laboratory==True)).select():}}		
					{{editable_var='false'}}
					{{if request.vars['op'] == "showEditCategory":}}
		            	{{if str(request.vars['var_id']) == str(project.id):}}
		            		{{editable_var='true'}}
		            	{{else:}}
		            		{{editable_var='false'}}
		            	{{pass}}
		        	{{pass}}
						<tr>
						<td>
							{{if editable_var=='true':}}						
								<select class="generic-widget" id="edit_category_id" name="category" style="width:75px;">
									<option value="{{=project.category}}">{{=project.category.category}}</option>
							      {{project_var = db(db.user_project.id == request.vars['assignation']).select().first() }}

						      	{{if auth.has_membership('Teacher'):}}
									{{cR = db((db.course_activity_category.semester==semestre2.id) & (db.course_activity_category.assignation==project_var.project.id) & (db.course_activity_category.laboratory==False)).select()}}
									{{categoriasP = []}}
								      {{for c in cR:}}
								          {{categoriasP.append(c.category)}}
								      {{pass}}
								      {{for cat in db(~db.activity_category.id.belongs(categoriasP)).select():}}
								          <option value="{{=cat.id}}">{{=cat.category}}</option>
								      {{pass}}
								{{else:}}
									{{cR = db((db.course_activity_category.semester==semestre2.id) & (db.course_activity_category.assignation==project_var.project.id) & (db.course_activity_category.laboratory==True)).select()}}
									{{categoriasP = []}}
								    {{for c in cR:}}
								          {{categoriasP.append(c.category)}}
								      {{pass}}
								      {{for cat in db((~db.activity_category.id.belongs(categoriasP)) & (db.activity_category.hidden_academic_tutor != True) ).select():}}
								          <option value="{{=cat.id}}">{{=cat.category}}</option>
								      {{pass}}
								{{pass}}
							    </select>
							{{else:}}
								{{=project.category.category}}
							{{pass}}
						</td>
						<td>
							{{if editable_var=='true':}}
								<input class="string" name="edit_grade" type="text" value="{{=project.grade}}" id="edit_grade" style="width:40px;">
							{{else:}}
								{{=project.grade}}
								
							{{pass}}
							{{total_var = total_var + project.grade}}					
						</td>
						<td>
							{{var_sg = str(project.specific_grade)}}
							{{if var_sg == 'True':}}
								{{var_sg="False"}}
							{{else:}}
								{{var_sg="True"}}
							{{pass}}
							{{if editable_var=='true':}}
								
								{{if var_sg =='True':}}
									<input type="checkbox" name="edit_SG_check"  id="edit_SG_check" checked>
								{{else:}}
									<input type="checkbox" name="edit_SG_check"  id="edit_SG_check">
								{{pass}}						
							{{else:}}
								{{=var_sg}}
							{{pass}}
						</td>
						{{if request.vars['op'] != "showTableNoEditable":}}
						<td>
							<center>
								

		                    	{{if editable_var=='true':}}
									<a id="categoryButton" role="button" class="badge btn-success"  
									onclick="updateCategory({{=project.id}});"> 
			                    		<span class="icon-white icon-check"></span>
			                    	</a>
		                    	{{else:}}
		                    		
			                    		<a id="categoryButton" role="button" class="badge btn-info"  
										onclick="editCategory({{=project.id}});"> 
				                    		<span class="icon-white icon-edit"></span>
				                    	</a>

		                    	{{pass}}

		                    	<a id="categoryButton" role="button" class="badge btn-danger" 
		                    	onclick="removeCategory({{=project.id}});" title="{{=T('Remove weighting category')}}" > 
		                    		<span class="icon-white icon-remove-sign"></span>
		                    	</a>
							</center>
						</td>
						{{pass}}
					</tr>
					{{pass}}
			{{pass}}
			
				

			
			<tr >
				<td style="background-color:#eee;">
					{{=T('Total')}}
				</td>
				<td style="background-color:#eee;">
					{{if total_var != 100:}}
						<b><font color="red">{{=total_var}}</font></b>
					{{else:}}
						<b><font color="green">{{=total_var}}</font></b>
					{{pass}}
				</td>
				<td style="background-color:#eee;">
				</td>
				{{if request.vars['op'] != "showTableNoEditable":}}
					<td style="background-color:#eee;">
					</td>
				{{pass}}
				{{if auth.has_membership('Teacher'):}}
					<td style="background-color:#eee;">
					</td>
				{{pass}}
			</tr>
			
		<table>		
	  </center>	
	</div>
{{pass}}



<script type="text/javascript">
  	
  	$(document).ready(function(){
		
			
	});

	function editCategory(var_id){
			$("#div_weighting_show").load("{{=URL('activity_control','weighting.html')}}?op=showEditCategory&amp;var_id="+var_id+"&amp;assignation={{=request.vars['assignation']}}");
	}

	function updateCategory(var_id){
	  var category_id_var = document.getElementById('edit_category_id').value;
      var grade_var = document.getElementById('edit_grade').value;
      var SG_var = document.getElementById('edit_SG_check').checked;
      var TP_var = document.getElementById('edit_TP_check').checked;

      

	      if (category_id_var==""){
	        alert("{{=T('No categories available')}}");  
	      }else{
	      
	      var regex = /^\d+(?:\.\d{0,2})$/; 
	      var regex2 = /^([0-9])*$/; 

	        if (grade_var=="" || parseInt(grade_var) == 0 ){
	          alert("{{=T('The entered value is not correct')}}");  
	        }else{
	          if (!regex.test(grade_var) && !regex2.test(grade_var) ){
	            alert("{{=T('The entered value is not a decimal')}}");  
	          }else{
	            
	            $("#div_weighting_show").load("{{=URL('activity_control','weighting.html')}}?op=updateCategory&amp;var_id="+var_id+"&amp;op2=showEditTable&amp;SG_var=" + SG_var + "&amp;TP_var=" + TP_var + "&amp;category_id_var=" + category_id_var +"&amp;grade_var=" + grade_var + "&amp;assignation={{=request.vars['assignation']}}"); 
	            $("#categoryDiv").load("{{=URL('activity_control','weighting.html')}}?op=showInsert&amp;assignation={{=request.vars['assignation']}}");
	            }       

	        }
	      }		
			
		}

	function removeCategory(var_id){
		var r = confirm("{{=T('Do you want to delete this record?')}}");
		if (r == true) {
		   $("#div_weighting_show").load("{{=URL('activity_control','weighting.html')}}?op=removeCategory&amp;op2={{=request.vars['op']}}&amp;var_id="+var_id+"&amp;assignation={{=request.vars['assignation']}}");

			$("#categoryDiv").load("{{=URL('activity_control','weighting.html')}}?op=showInsert&amp;assignation={{=request.vars['assignation']}}");
		} else {
			$("#categoryDiv").load("{{=URL('activity_control','weighting.html')}}?op=showInsert&amp;assignation={{=request.vars['assignation']}}");
		} 
			
	}

</script>
