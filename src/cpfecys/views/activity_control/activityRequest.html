{{if request.vars['op']=="solveActivityRequest":}}
	{{if request.vars['tip']=="p":}}
		{{allRequest = db((db.requestchange_activity.status=='Pending')&(db.requestchange_activity.semester==int(semestre2.id))&(db.requestchange_activity.course==int(request.vars['course']))).select()}}
	{{pass}}
	{{if request.vars['tip']=="a":}}
		{{allRequest = db((db.requestchange_activity.status=='Accepted')&(db.requestchange_activity.semester==int(semestre2.id))&(db.requestchange_activity.course==int(request.vars['course']))).select()}}
	{{pass}}
	{{if request.vars['tip']=="r":}}
		{{allRequest = db((db.requestchange_activity.status=='Rejected')&(db.requestchange_activity.semester==int(semestre2.id))&(db.requestchange_activity.course==int(request.vars['course']))).select()}}
	{{pass}}
	{{if request.vars['tip']=="t":}}
		{{allRequest = db((db.requestchange_activity.semester==int(semestre2.id))&(db.requestchange_activity.course==int(request.vars['course']))).select()}}
	{{pass}}
	<table class="table table-striped table-bordered">
		<tr>
			<th>{{=T('User')}}</th>
			<th>{{=T('Role')}} </th>
			<th>{{=T('Status')}}</th>
			<th>Fecha Solicitud</th>
			<th>{{=T('Action')}}</th>
		</tr>
	{{for change in allRequest:}}
		<tr>
			<td>{{=change.user_id.username}}</td>
			<td>{{=T(change.roll)}}</td>
			<td>{{=T(change.status)}}</td>
			<td>{{=change.date_request}}</td>
			<td>
				<a class="btn" title="{{=T('View the change request')}}" onclick="detail({{=change.id}});">{{=T('Detail')}}</a>
			</td>
		</tr>
	{{pass}}
	</table>
{{pass}}



{{if request.vars['op']=="solveActivityRequestDetail":}}
	{{Request = db(db.requestchange_activity.id==int(request.vars['Idrequest'])).select().first()}}
	<table class="table table-striped table-bordered">
		<tr>
			<th colspan="6"><center>{{=T('Change Request')}}</center></th>
		</tr>
		<tr>
			<th>{{=T('User')}}</th><td>{{=Request.user_id.username}}</td>
			<th>{{=T('Role')}}</th><td>{{=T(Request.roll)}}</td>
			<th>{{=T('Date Request')}}</th><td>{{=Request.date_request}}</td>
		</tr>
		<tr>
			<th>{{=T('Status')}}:</th>
			{{if Request.status=='Pending':}}
				<th><FONT COLOR="#5E610B">{{=T(Request.status)}}</font></th>
			{{elif Request.status=='Accepted':}}
				<th><FONT COLOR="Green">{{=T(Request.status)}}</font></th>
			{{else:}}
				<th><FONT COLOR="Red">{{=T(Request.status)}}</font></th>
			{{pass}}
			<th>{{=T('Date of resolution')}}</th>
			{{if Request.status=='Pending':}}
				<td>---</td>
			{{else:}}
				<td>{{=Request.date_request_resolve}}</td>
			{{pass}}
			<th>{{=T('Role resolution')}}</th>
			{{if Request.status=='Pending':}}
				<td>---</td>
			{{else:}}
				<td>{{=Request.roll_resolve}}</td>
			{{pass}}
		</tr>
		<tr>
			<th>{{=T('Description')}}:</th>
			<td colspan="5"><pre>{{=Request.description}}</pre></td>
		</tr>
		<tr>
			<th colspan="6"><center>{{=T('Detail of Request')}}</center></th>
		</tr>
		<tr>
			<th>Operación</th>
			<th>Nombre Actividad</th>
			<th>Descripción Actividad</th>
			<th>Nota de Actividad</th>
			<th>Fecha de Inicio</th>
			<th>Fecha de Finalización</th>
		</tr>
		{{for change in db(db.requestchange_course_activity.requestchange_activity==Request.id).select():}}
			<tr>
				<td>{{=change.operation_request}}</td>
				<td>{{=change.name}}</td>
				<td>{{=change.description}}</td>
				<td>{{=change.grade}}</td>
				<td>{{=change.date_start}}</td>
				<td>{{=change.date_finish}}</td>
			</tr>
		{{pass}}
		<tr>
			{{if Request.status=='Pending':}}
				<td colspan="3"></td>
				<td><center>
					<a role="button" onclick="acceptRequestChange({{=Request.id}});" class="btn btn-success"  title="{{=T('Accept the change request planning')}}"> <span class="icon-white icon-remove-sign"></span>{{=T('Accept Request')}}</a>
				</center></td>
				<td><center>
					<a role="button" onclick="rejectRequestChange({{=Request.id}});" class="btn btn-danger"  title="{{=T('Reject the change request planning')}}"> <span class="icon-white icon-remove-sign"></span>{{=T('Reject Request')}}</a>
				</center></td>
			{{else:}}
				<td colspan="5"></td>
			{{pass}}
			<td><center>
				<a class="btn" title="{{=T('Close the detail of the change request')}}" onclick="closeDetail();">{{=T('Close Detail')}}</a>
			</center></td>
		</tr>
	</table>
{{pass}}



{{if request.vars['op']=="rejectRequestChange":}}
	{{from datetime import datetime}}
	{{if auth.has_membership('Teacher'):}}
		{{db(db.requestchange_activity.id==int(request.vars['Idrequest'])).update(status = 'Rejected', user_name_resolve = auth.user.username, roll_resolve =  'Teacher', date_request_resolve =  str(datetime.now()))}}
	{{else:}}
		{{db(db.requestchange_activity.id==int(request.vars['Idrequest'])).update(status = 'Rejected', user_name_resolve = auth.user.username, roll_resolve =  'Super-Administrator', date_request_resolve = str(datetime.now()))}}
	{{pass}}
	<script type="text/javascript">
		location.href="{{=URL('activity_control','solve_request_change_activity.html')}}?course={{=request.vars['course']}}";
	</script>
{{pass}}




{{if request.vars['op']=="acceptRequestChange":}}
	{{from datetime import datetime}}
	{{nombreRol=None}}
	{{if auth.has_membership('Teacher'):}}
		{{db(db.requestchange_activity.id==int(request.vars['Idrequest'])).update(status = 'Accepted', user_name_resolve = auth.user.username, roll_resolve =  'Teacher', date_request_resolve =  str(datetime.now()))}}
		{{nombreRol='Teacher'}}
	{{else:}}
		{{nombreRol='Super-Administrator'}}
		{{db(db.requestchange_activity.id==int(request.vars['Idrequest'])).update(status = 'Accepted', user_name_resolve = auth.user.username, roll_resolve =  'Super-Administrator', date_request_resolve = str(datetime.now()))}}
	{{pass}}

	{{Request = db(db.requestchange_activity.id==int(request.vars['Idrequest'])).select().first()}}
	{{for change in db(db.requestchange_course_activity.requestchange_activity==Request.id).select():}}
		{{if change.operation_request=='insert':}}
			{{db.course_activity.insert(course_activity_category = change.course_activity_category,
													name=change.name,
													description=change.description,
					                                grade =  change.grade, 
					                                semester = Request.semester, 
					                                assignation = Request.course, 
					                                laboratory = 'T',
					                                teacher_permition = 'F',
					                                date_start = change.date_start,
					                                date_finish = change.date_finish)}}

			{{db.course_activity_log.insert(user_name=auth.user.username,
													roll=nombreRol,
													operation_log='insert',
													course= Request.course.name,
													yearp=Request.semester.yearp,
													period=T(Request.semester.period.name),
													metric='T',
													after_course_activity_category=change.course_activity_category,
													after_name=change.name,
													after_description=change.description,
					                                after_grade =  change.grade,
					                                after_laboratory = 'T',
					                                after_teacher_permition = 'F',
					                                after_date_start = change.date_start,
					                                after_date_finish = change.date_finish)}}
		{{elif change.operation_request=='update':}}
			{{activityOldR = db(db.course_activity.id==change.activity).select().first()}}
			{{db(db.course_activity.id==change.activity).update(name=change.name, description=change.description, grade =  change.grade, date_start = change.date_start, date_finish = change.date_finish)}}

			{{db.course_activity_log.insert(user_name=auth.user.username,
													roll=nombreRol,
													operation_log='update',
													course= Request.course.name,
													yearp=Request.semester.yearp,
													period=T(Request.semester.period.name),
													metric='T',
													before_course_activity_category=activityOldR.course_activity_category.category.category,
													before_name=activityOldR.name,
													before_description=activityOldR.description,
					                                before_grade =  activityOldR.grade,
					                                before_laboratory = activityOldR.laboratory,
					                                before_teacher_permition = activityOldR.teacher_permition,
					                                before_date_start = activityOldR.date_start,
					                                before_date_finish = activityOldR.date_finish,
					                                after_course_activity_category=activityOldR.course_activity_category.category.category,
					                                after_name=change.name,
													after_description=change.description,
					                                after_grade =  change.grade,
					                                after_laboratory = activityOldR.laboratory,
					                                after_teacher_permition = activityOldR.teacher_permition,
					                                after_date_start = change.date_start,
					                                after_date_finish = change.date_finish)}}
		{{else:}}
			{{activity_var = db((db.course_activity.name == change.name)&(db.course_activity.description==change.description)&(db.course_activity.grade==change.grade)&(db.course_activity.date_start==change.date_start)&(db.course_activity.date_finish==change.date_finish)).select().first()}}
			{{db.course_activity_log.insert(user_name=auth.user.username,
												roll=nombreRol,
												operation_log='delete',
												course= Request.course.name,
												yearp=Request.semester.yearp,
												period=T(Request.semester.period.name),
												metric='T',
												before_course_activity_category=activity_var.course_activity_category.category.category,
												before_name=activity_var.name,
												before_description=activity_var.description,
				                                before_grade =  activity_var.grade,
				                                before_laboratory = activity_var.laboratory,
				                                before_teacher_permition = activity_var.teacher_permition,
				                                before_date_start = activity_var.date_start,
				                                before_date_finish = activity_var.date_finish)}}
			{{db(db.course_activity.id==activity_var.id).delete()}}
		{{pass}}
	{{pass}}

	<script type="text/javascript">
		location.href="{{=URL('activity_control','solve_request_change_activity.html')}}?course={{=request.vars['course']}}";
	</script>
{{pass}}